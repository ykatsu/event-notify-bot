# event-notify-bot

### Google Calenderの通知をSlackへPostするBot作ってみた

本日の予定一覧をつぶやくbotは多いけど、予定に設定してある通知の時刻になったら教えてくれるbotが見当たらなかったので GAS(Googls Apps Script) で作ってみた。  
(Slack の Integration API に Google Calendar はあるんだけど、これも予定の時間になったら教えてくれるだけで、５分前とか教えてくれない)

チーム全体のカレンダーを登録して使用する事を想定しています。  
例えば、午前９時〜１２時に「午前中停電の為、出社できません」というイベントを作り、ポップアップ通知を前日の９時と１８時に設定しておくと、以下のメッセージが表示されます。（たぶんきっと）

```
「明日は午前中停電の為、出社できません」
```

会議の時間は忘れなくても、こういうのウッカリしがち。  
もちろん会議の５分前に通知を出す事も出来ますよ。(４分前ぐらいになるかもだけど)

### 注意事項

GASへ貼り付ける時は Javascriptへコンパイルしてご使用ください。Chrome 上の CoffeeConsole がお手軽かな？

そもそもトリガが毎分起動じゃなく１分毎起動なので１分ほど遅れて通知が来る事もしばしばです。また、GASサーバーがそんなキッチリ働くかもわからないので、その辺を勘案の上ご利用ください。

シートのB1の場所に前回処理した時間を取っておいて、それ以降現在までに起きた通知を見つけて出力するようにしています。なので、スプレッドシートベースでの作成が必要です。  
また、妥当性のチェックは入れてませんので、勝手に書き換えるとどうなっても知りません。

終日予定の通知の取得方法が分からなかった為、それに関しては通知されません。

使用は自己責任でお願いします。

### 処理説明

1. Calendar オブジェクトを取得
1. 一週間先までのイベントを全て取得
1. 各イベントのポップアップ通知を全て取得
1. 前回の処理から現在までの間にポップアップすべきものがあれば Slack へ Post
1. その時にイイカンジのメッセージが出る様にゴリゴリ

#### 設定方法

1. Googleマイドライブ上で新規にスプレッドシート作成
1. [ツール]-[スクリプトエディタ] でエディタ起動
1. Javascript化したソースを貼り付ける。
1. SlackApp をライブラリに追加。こことか参考に-> [Slack BotをGASでいい感じで書くためのライブラリを作った](http://qiita.com/soundTricker/items/43267609a870fc9c7453)
1. ソース先頭の各種リテラル (Slackのtoken、投稿するチャンネルのid、カレンダーid)  を適宜設定する(取得方法はぐぐってね)
1. [リソース]-[現在のプロジェクトのトリガー] からトリガーをdoPostに設定する。  
このとき、coffeescriptからコンパイルしたソースだとdoPostメソッドが見つからないというエラーになる場合がある。その場合はdoPost を変数からメソッドへ変更する。

JavaScript ソース上で、これを

```js
doPost = function() {
```

こうする

```js
function doPost() {
```

### 使用ライブラリ

- [SlackApp](http://qiita.com/soundTricker/items/43267609a870fc9c7453)
